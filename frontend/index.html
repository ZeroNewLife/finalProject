<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedCard NFT - Полная версия</title>
    <style>
        /* ... (CSS код не изменен) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1b3d 50%, #2d1b4e 100%);
            color: #fff;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            animation: glow 3s infinite;
        }

        h1 {
            font-size: 3em;
            background: linear-gradient(45deg, #8b5cf6, #ec4899, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.2em;
            color: #a78bfa;
        }

        .wallet-section {
            background: rgba(0, 0, 0, 0.4);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(139, 92, 246, 0.4);
            backdrop-filter: blur(10px);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .info-item .label {
            color: #a78bfa;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-item .value {
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            word-break: break-all;
        }

        .btn {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 25px rgba(139, 92, 246, 0.4);
            font-weight: 600;
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 35px rgba(139, 92, 246, 0.6);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #06b6d4, #10b981);
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 0.9em;
            width: auto;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(0, 0, 0, 0.5);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(10px);
            animation: float 6s ease-in-out infinite;
        }

        .card:hover {
            border-color: rgba(139, 92, 246, 0.8);
        }

        .card h2 {
            color: #a78bfa;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #c4b5fd;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 10px;
            color: white;
            font-size: 1em;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .preview-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            margin-top: 20px;
        }

        .preview-box h3 {
            color: #ec4899;
            margin-bottom: 15px;
        }

        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            font-size: 0.9em;
            color: #93c5fd;
        }

        .price-display {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            border: 2px solid rgba(139, 92, 246, 0.4);
        }

        .price-display .amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #8b5cf6;
            margin: 10px 0;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #6ee7b7;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        .status-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }

        .spinner {
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nft-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .nft-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            transition: all 0.3s;
        }

        .nft-card:hover {
            transform: translateY(-5px);
            border-color: #8b5cf6;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .nft-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
        }

        .access-list {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .access-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .access-item span {
            color: #c4b5fd;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(10, 14, 39, 0.95);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(139, 92, 246, 0.5);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #a78bfa;
            margin-bottom: 20px;
        }

        .close-modal {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #ec4899;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <div class="container">
        <header>
            <h1>🚀 MedCard NFT Platform</h1>
            <p class="tagline">Децентрализованная платформа медицинских карт</p>
        </header>

        <div class="wallet-section">
            <div class="info-grid">
                <div class="info-item">
                    <div class="label">Кошелек</div>
                    <div class="value" id="walletAddress">Не подключен</div>
                </div>
                <div class="info-item">
                    <div class="label">Сеть</div>
                    <div class="value" id="networkName">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Баланс</div>
                    <div class="value" id="balance">0 ETH</div>
                </div>
            </div>
            <button class="btn" id="connectBtn">Подключить MetaMask</button>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2>📋 Создать медкарту</h2>
                
                <div class="form-group">
                    <label>ФИО пациента *</label>
                    <input type="text" id="patientName" placeholder="Иванов Иван Иванович" />
                </div>

                <div class="form-group">
                    <label>Дата рождения *</label>
                    <input type="date" id="birthDate" />
                </div>

                <div class="form-group">
                    <label>Диагноз *</label>
                    <textarea id="diagnosis" rows="3" placeholder="Основной диагноз..."></textarea>
                </div>

                <div class="form-group">
                    <label>Дополнительная информация</label>
                    <textarea id="additionalInfo" rows="2" placeholder="Аллергии, заболевания..."></textarea>
                </div>

                <div class="price-display">
                    <div class="label">Стоимость минта</div>
                    <div class="amount">0.005 ETH</div>
                </div>

                <button class="btn btn-secondary" id="createBtn" disabled>
                    Создать медкарту NFT
                </button>

                <div id="statusMessage" class="status-message"></div>
            </div>

            <div class="card">
                <h2>👁️ Предпросмотр</h2>
                
                <div class="preview-box">
                    <h3>Публичные метаданные</h3>
                    <pre id="publicPreview">{
  "name": "Медкарта: ...",
  "description": "..."
}</pre>
                </div>

                <div class="preview-box">
                    <h3>🔒 Приватные данные</h3>
                    <pre id="privatePreview">{
  "fullName": "...",
  "diagnosis": "..."
}</pre>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>🎨 Мои медицинские карты</h2>
            <button class="btn" id="loadNFTsBtn" disabled>Загрузить мои NFT</button>
            <div class="nft-gallery" id="nftGallery">
                <div style="text-align: center; color: #a78bfa; padding: 40px;">
                    Подключите кошелек
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="accessModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2>Управление доступом к медкарте #<span id="modalTokenId"></span></h2>
            
            <div class="form-group">
                <label>Адрес врача</label>
                <input type="text" id="doctorAddress" placeholder="0x..." />
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-secondary btn-small" onclick="grantAccessToDoctor()">
                    Дать доступ
                </button>
                <button class="btn btn-small" onclick="revokeAccessFromDoctor()">
                    Отозвать доступ
                </button>
            </div>

            <div class="form-group">
                <label>Проверить доступ адреса</label>
                <input type="text" id="checkAccessAddress" placeholder="0x..." />
                <button class="btn btn-small" onclick="checkDoctorAccess()" style="margin-top: 10px;">
                    Проверить
                </button>
            </div>

            <div id="accessResult" style="margin-top: 15px;"></div>

            <hr style="border-color: rgba(139, 92, 246, 0.3); margin: 20px 0;">

            <button class="btn btn-secondary" onclick="viewPrivateData()">
                🔓 Просмотреть приватные данные
            </button>

            <div id="privateDataResult" style="margin-top: 15px;"></div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    
    <script>
        console.log('=== ПРОВЕРКА ЗАГРУЗКИ БИБЛИОТЕК ===');
        console.log('ethers загружен?', typeof ethers !== 'undefined');
        console.log('ethers версия:', typeof ethers !== 'undefined' ? ethers.version : 'НЕ ЗАГРУЖЕН');
        console.log('window.ethereum (MetaMask)?', typeof window.ethereum !== 'undefined');
        console.log('=====================================');
    </script>

    <script>
        // === КОНФИГУРАЦИЯ ===
        const CONFIG = {
            CONTRACT_ADDRESS: '0xA05A6361339f018712E292b32362cf8a2c610F5f',
            MINT_PRICE: '0.005',
            ABI: [
                "function safeMint(address to, string tokenMetadataUri, string initialPrivateUri) payable returns (uint256)",
                "function balanceOf(address owner) view returns (uint256)",
                "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
                "function tokenURI(uint256 tokenId) view returns (string)",
                "function getPrivateTokenURI(uint256 tokenId) view returns (string)",
                "function grantAccess(uint256 tokenId, address doctor)",
                "function revokeAccess(uint256 tokenId, address doctor)",
                "function hasAccess(uint256 tokenId, address addr) view returns (bool)"
            ]
        };

        // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
        let provider, signer, contract, userAddress;
        let currentTokenId = null;

        // === ГЕНЕРАЦИЯ ЗВЕЗД ===
        window.addEventListener('load', () => {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        });

        // === ПОДКЛЮЧЕНИЕ КОШЕЛЬКА ===
        document.getElementById('connectBtn').addEventListener('click', async () => {
    try {
        console.log('Попытка подключения к MetaMask...');
        
        if (!window.ethereum) {
            showStatus('MetaMask не установлен! Установите: https://metamask.io', 'error');
            return;
        }

        showStatus('Подключение к MetaMask...', 'info');

        // ДЛЯ ETHERS V5:
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        console.log('Подключен адрес:', userAddress);

        // Получаем информацию о сети
        const network = await provider.getNetwork();
        const balanceWei = await provider.getBalance(userAddress);
        const balanceEth = ethers.utils.formatEther(balanceWei); // Обрати внимание на utils.

        // Обновляем UI
        document.getElementById('walletAddress').textContent = 
            userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
        document.getElementById('networkName').textContent = network.name;
        document.getElementById('balance').textContent = 
            parseFloat(balanceEth).toFixed(4) + ' ETH';

        // Инициализируем контракт
        contract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, CONFIG.ABI, signer);
        console.log('Контракт инициализирован:', CONFIG.CONTRACT_ADDRESS);

        // Активируем кнопки
        document.getElementById('connectBtn').textContent = 'Подключено ✓';
        document.getElementById('connectBtn').disabled = true;
        document.getElementById('createBtn').disabled = false;
        document.getElementById('loadNFTsBtn').disabled = false;

        showStatus('✅ Кошелек успешно подключен!', 'success');

    } catch (error) {
        console.error('Ошибка подключения:', error);
        showStatus('❌ Ошибка: ' + error.message, 'error');
    }
});

        // === СОЗДАНИЕ МЕДКАРТЫ ===
        document.getElementById('createBtn').addEventListener('click', async () => {
            try {
                const name = document.getElementById('patientName').value.trim();
                const birthDate = document.getElementById('birthDate').value;
                const diagnosis = document.getElementById('diagnosis').value.trim();

                if (!name || !birthDate || !diagnosis) {
                    showStatus('❌ Заполните обязательные поля!', 'error');
                    return;
                }

                if (!contract) {
                    showStatus('❌ Сначала подключите кошелек!', 'error');
                    return;
                }

                document.getElementById('createBtn').disabled = true;
                document.getElementById('createBtn').textContent = '⏳ Создание...';

                showStatus('⏳ Подготовка метаданных...', 'info');

                // Создаем метаданные (в реальности загружаем в IPFS)
                const publicCID = 'QmPublic' + Date.now();
                const privateCID = 'QmPrivate' + Date.now();

                showStatus('⏳ Минтим NFT... Подтвердите транзакцию (0.005 ETH)', 'info');

                const tx = await contract.safeMint(
                    userAddress,
                    `ipfs://${publicCID}`,
                    `ipfs://${privateCID}`,
                    // ИСПРАВЛЕНИЕ: Используем ethers.utils.parseEther для V5
                    { value: ethers.utils.parseEther(CONFIG.MINT_PRICE) } 
                );

                showStatus('⏳ Ожидание подтверждения транзакции...', 'info');
                const receipt = await tx.wait();

                showStatus(`✅ NFT создан! Tx: ${receipt.hash.slice(0, 10)}...`, 'success');

                // Очистка формы
                document.getElementById('patientName').value = '';
                document.getElementById('birthDate').value = '';
                document.getElementById('diagnosis').value = '';
                document.getElementById('additionalInfo').value = '';
                updatePreviews();

            } catch (error) {
                console.error('Ошибка минта:', error);
                let errorMsg = error.message;
                if (error.code === 'ACTION_REJECTED') {
                    errorMsg = 'Транзакция отклонена пользователем';
                }
                showStatus('❌ ' + errorMsg, 'error');
            } finally {
                document.getElementById('createBtn').disabled = false;
                document.getElementById('createBtn').textContent = 'Создать медкарту NFT';
            }
        });

        // === ЗАГРУЗКА NFT ===

        
        document.getElementById('loadNFTsBtn').addEventListener('click', async () => {
            try {
                if (!contract || !userAddress) return;

                const gallery = document.getElementById('nftGallery');
                gallery.innerHTML = '<div class="spinner"></div>';

                const balance = await contract.balanceOf(userAddress);
                const count = Number(balance);

                if (count === 0) {
                    gallery.innerHTML = '<div style="text-align: center; color: #a78bfa; padding: 40px;">У вас нет NFT</div>';
                    return;
                }

                gallery.innerHTML = '';

                for (let i = 0; i < count; i++) {
                    const tokenId = await contract.tokenOfOwnerByIndex(userAddress, i);
                    const tokenURI = await contract.tokenURI(tokenId);

                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.innerHTML = `
                        <div class="nft-image">🏥</div>
                        <h3>Медкарта #${tokenId}</h3>
                        <p>${tokenURI.slice(0, 30)}...</p>
                        <button class="btn btn-small" onclick="openAccessModal(${tokenId})">
                            Управление доступом
                        </button>
                    `;
                    gallery.appendChild(card);
                }

            } catch (error) {
                console.error(error);
                showStatus('Ошибка загрузки NFT: ' + error.message, 'error');
            }
        });

        // === УПРАВЛЕНИЕ ДОСТУПОМ ===
        function openAccessModal(tokenId) {
            currentTokenId = tokenId;
            document.getElementById('modalTokenId').textContent = tokenId;
            document.getElementById('accessModal').classList.add('active');
            document.getElementById('accessResult').innerHTML = '';
            document.getElementById('privateDataResult').innerHTML = '';
        }

        function closeModal() {
            document.getElementById('accessModal').classList.remove('active');
            currentTokenId = null;
        }

        async function grantAccessToDoctor() {
            try {
                const doctorAddr = document.getElementById('doctorAddress').value.trim();
                if (!doctorAddr) {
                    alert('Введите адрес врача');
                    return;
                }

                showStatus('⏳ Даем доступ врачу...', 'info');
                const tx = await contract.grantAccess(currentTokenId, doctorAddr);
                await tx.wait();
                
                document.getElementById('accessResult').innerHTML = 
                    '<div class="status-success">✅ Доступ предоставлен!</div>';
                showStatus('✅ Доступ предоставлен врачу!', 'success');
            } catch (error) {
                console.error(error);
                document.getElementById('accessResult').innerHTML = 
                    `<div class="status-error">❌ ${error.message}</div>`;
            }
        }

        async function revokeAccessFromDoctor() {
            try {
                const doctorAddr = document.getElementById('doctorAddress').value.trim();
                if (!doctorAddr) {
                    alert('Введите адрес врача');
                    return;
                }

                showStatus('⏳ Отзываем доступ...', 'info');
                const tx = await contract.revokeAccess(currentTokenId, doctorAddr);
                await tx.wait();
                
                document.getElementById('accessResult').innerHTML = 
                    '<div class="status-success">✅ Доступ отозван!</div>';
                showStatus('✅ Доступ отозван!', 'success');
            } catch (error) {
                console.error(error);
                document.getElementById('accessResult').innerHTML = 
                    `<div class="status-error">❌ ${error.message}</div>`;
            }
        }

        async function checkDoctorAccess() {
            try {
                const addr = document.getElementById('checkAccessAddress').value.trim();
                if (!addr) {
                    alert('Введите адрес для проверки');
                    return;
                }

                const hasAccess = await contract.hasAccess(currentTokenId, addr);
                
                document.getElementById('accessResult').innerHTML = hasAccess
                    ? '<div class="status-success">✅ У этого адреса ЕСТЬ доступ</div>'
                    : '<div class="status-error">❌ У этого адреса НЕТ доступа</div>';
            } catch (error) {
                console.error(error);
                document.getElementById('accessResult').innerHTML = 
                    `<div class="status-error">❌ ${error.message}</div>`;
            }
        }

        async function viewPrivateData() {
            try {
                showStatus('⏳ Получаем приватные данные...', 'info');
                const privateURI = await contract.getPrivateTokenURI(currentTokenId);
                
                document.getElementById('privateDataResult').innerHTML = `
                    <div class="preview-box">
                        <h3>🔓 Приватный URI</h3>
                        <pre>${privateURI}</pre>
                        <p style="color: #a78bfa; margin-top: 10px;">
                            В реальной системе здесь будут расшифрованные медицинские данные
                        </p>
                    </div>
                `;
                showStatus('✅ Приватные данные получены!', 'success');
            } catch (error) {
                console.error(error);
                document.getElementById('privateDataResult').innerHTML = 
                    `<div class="status-error">❌ Нет доступа или ошибка: ${error.message}</div>`;
            }
        }

        // === ОБНОВЛЕНИЕ ПРЕВЬЮ ===
        function updatePreviews() {
            const name = document.getElementById('patientName').value || '...';
            const date = document.getElementById('birthDate').value || '...';
            const diagnosis = document.getElementById('diagnosis').value || '...';
            const info = document.getElementById('additionalInfo').value || '...';

            const publicData = {
                name: `Медкарта: ${name}`,
                description: `Пациент: ${name}\\nДата рождения: ${date}`,
                image: "ipfs://..."
            };

            const privateData = {
                fullName: name,
                birthDate: date,
                diagnosis: diagnosis,
                additionalInfo: info
            };

            document.getElementById('publicPreview').textContent = 
                JSON.stringify(publicData, null, 2);
            document.getElementById('privatePreview').textContent = 
                JSON.stringify(privateData, null, 2);
        }

        // === ПОКАЗАТЬ СТАТУС ===
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 8000);
            }
        }

        // === АВТООБНОВЛЕНИЕ ПРЕВЬЮ ===
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = ['patientName', 'birthDate', 'diagnosis', 'additionalInfo'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updatePreviews);
                }
            });
            updatePreviews();
        });

        // === ЗАКРЫТИЕ МОДАЛКИ ПО ESC ===
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>